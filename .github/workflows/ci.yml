name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Core Build & Test (必須・3分以内目標)
  # =============================================================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DSAPPP_BUILD_TESTS=ON \
            -DSAPPP_BUILD_CLANG_FRONTEND=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        working-directory: build
        run: ctest --output-on-failure --parallel $(nproc)

  # =============================================================================
  # Schema Validation (スキーマ破壊を防ぐ)
  # =============================================================================
  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate Schemas
        run: |
          npm install -g ajv-cli ajv-formats
          for schema in schemas/*.schema.json; do
            echo "Validating: $schema"
            ajv compile -s "$schema" --spec=draft7 -c ajv-formats || exit 1
          done

  # =============================================================================
  # Determinism Check (SAP++の核心要件)
  # =============================================================================
  determinism:
    name: Determinism Check
    runs-on: ubuntu-22.04
    needs: build-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Build
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DSAPPP_BUILD_TESTS=ON \
            -DSAPPP_BUILD_CLANG_FRONTEND=OFF
          cmake --build build --parallel

      - name: Run Determinism Tests (3 times)
        working-directory: build
        run: |
          for i in 1 2 3; do
            echo "=== Run $i ==="
            ctest -R "Determinism|Canonical|SHA256" --output-on-failure || exit 1
          done

  # =============================================================================
  # Quality Gate
  # =============================================================================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-22.04
    needs: [build-and-test, schema-validation, determinism]
    if: always()
    steps:
      - name: Check Results
        run: |
          if [[ "${{ needs.build-and-test.result }}" != "success" ]] || \
             [[ "${{ needs.schema-validation.result }}" != "success" ]] || \
             [[ "${{ needs.determinism.result }}" != "success" ]]; then
            echo "❌ Quality gate failed"
            exit 1
          fi
          echo "✅ Quality gate passed"
