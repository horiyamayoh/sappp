# SAP++ Continuous Integration
#
# This workflow runs the exact same quality gate script as local Docker CI to
# prevent configuration drift between local and remote environments.
# Gate mode can be controlled via workflow_dispatch input or a repo variable.

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      gate_mode:
        description: "Quality gate mode: smart/full/ci"
        required: false
        default: ci
        type: choice
        options:
          - smart
          - full
          - ci

env:
  SAPPP_CI_GATE_MODE: ${{ inputs.gate_mode || vars.SAPPP_CI_GATE_MODE || 'ci' }}

jobs:
  quality-gate:
    name: Quality Gate (Docker)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run unified gate
        run: |
          if ! command -v docker >/dev/null; then
            echo "Docker is required for CI parity but was not found"
            exit 1
          fi

          MODE="${SAPPP_CI_GATE_MODE}"
          case "$MODE" in
            smart)
              ./scripts/docker-ci.sh --smart
              ;;
            full)
              ./scripts/docker-ci.sh
              ;;
            ci)
              ./scripts/docker-ci.sh --ci
              ;;
            *)
              echo "Invalid SAPPP_CI_GATE_MODE: $MODE (expected smart/full/ci)"
              exit 1
              ;;
          esac
